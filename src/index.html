<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="iPusnas Downloader - Download and manage your digital library from iPusnas" />
    <title>iPusnas Downloader</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div id="auth-section" class="auth-overlay" role="dialog" aria-labelledby="auth-title">
      <div class="auth-box">
        <div class="logo">
          <div class="logo-box" aria-hidden="true">i</div>
          <h1 id="auth-title">iPusnas <span style="font-weight: 300; opacity: 0.8">Downloader</span></h1>
        </div>
        <p class="auth-description">Sign in to sync your library.</p>
        <label for="email" class="visually-hidden">Email</label>
        <input type="email" id="email" placeholder="Email" aria-required="true" />
        <label for="password" class="visually-hidden">Password</label>
        <input type="password" id="password" placeholder="Password" aria-required="true" />
        <button id="login-btn" class="btn btn-primary btn-auth" aria-label="Login to iPusnas">Enter Library</button>
        <p id="error-msg" class="error-text" role="alert" aria-live="polite"></p>
      </div>
    </div>

    <div id="mobile-bar" class="mobile-nav hidden" role="banner">
      <div class="logo" style="margin-bottom: 0; padding-left: 0">
        <div class="logo-box" aria-hidden="true">i</div>
        <h1 style="font-size: 1.1rem">iPusnas Dashboard</h1>
      </div>
      <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Toggle navigation menu">‚ò∞</button>
    </div>

    <div id="sidebar-overlay" class="aside-overlay" onclick="toggleSidebar()" aria-hidden="true"></div>

    <div id="main-app" class="app-layout hidden">
      <aside id="main-sidebar" role="navigation" aria-label="Main navigation">
        <div class="logo">
          <div class="logo-box" aria-hidden="true">i</div>
          <h1>iPusnas <span style="font-weight: 300">Downloader</span></h1>
        </div>
        <nav class="nav-list" role="menubar">
          <li class="nav-item active" data-target="shelf-section" role="menuitem" tabindex="0"><span>Shelf Library</span></li>
          <li class="nav-item" data-target="local-section" role="menuitem" tabindex="0"><span>Offline Books</span></li>
        </nav>

        <div class="stats-box" role="status" aria-label="Library statistics">
          <p class="stats-title">Library Status</p>
          <div class="stat-row">
            <span class="stat-label">Synced Items</span>
            <span id="stat-shelf" class="stat-value" style="color: var(--primary)">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Available Offline</span>
            <span id="stat-local" class="stat-value" style="color: var(--green)">0</span>
          </div>
        </div>

        <button onclick="logout()" class="nav-item btn-logout" aria-label="Logout from session">
          <span>Logout Session</span>
        </button>
      </aside>

      <main role="main">
        <div class="header">
          <h2 id="section-title">Shelf Library</h2>
          <div class="search-box">
            <label for="search-input" class="visually-hidden">Search books</label>
            <input type="text" id="search-input" placeholder="Search books..." aria-label="Search books" />
          </div>
          <button onclick="loadAllData()" class="btn btn-outline btn-sync" aria-label="Sync library">Sync Library</button>
        </div>

        <section id="shelf-section" class="section active" role="region" aria-label="Shelf Library">
          <div class="grid" id="shelf-grid" role="list"></div>
        </section>

        <section id="local-section" class="section" role="region" aria-label="Offline Books">
          <div class="grid" id="local-grid" role="list"></div>
        </section>
      </main>
    </div>

    <style>
      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>

    <script>
      const API = {
        login: "/api/login",
        books: "/api/books",
        library: "/api/library",
        download: "/api/download/",
        openFolder: "/api/open-folder/",
        delete: "/api/delete/",
        files: "/api/files/",
        logout: "/api/logout",
      };

      const sanitizeHTML = (str) => {
        if (!str) return "";
        const div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
      };

      let shelfState = [];
      let localState = [];
      let currentSection = "shelf-section";
      const activeDownloads = new Map();

      const navItems = document.querySelectorAll(".nav-item");
      const sections = document.querySelectorAll(".section");
      const sectionTitle = document.getElementById("section-title");

      navItems.forEach((item) => {
        const handler = () => {
          const target = item.getAttribute("data-target");
          if (!target || item.classList.contains("active")) return;
          currentSection = target;

          navItems.forEach((i) => i.classList.remove("active"));
          item.classList.add("active");
          sections.forEach((s) => s.classList.remove("active"));
          document.getElementById(target).classList.add("active");
          sectionTitle.textContent = item.querySelector("span").textContent;

          document.getElementById("search-input").value = "";
          if (target === "local-section") loadLocalLibrary();
          else loadShelf();
        };

        item.addEventListener("click", handler);
        item.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            handler();
          }
        });
      });

      document.getElementById("search-input").addEventListener("input", (e) => {
        const query = e.target.value.toLowerCase().trim();
        if (currentSection === "shelf-section") {
          const filtered = shelfState.filter(
            (b) => b.book_title.toLowerCase().includes(query) || b.book_author.toLowerCase().includes(query)
          );
          renderShelf(filtered, true);
        } else {
          const filtered = localState.filter((b) => b.title.toLowerCase().includes(query));
          renderLocalLibrary(filtered);
        }
      });

      document.getElementById("login-btn").addEventListener("click", async () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const error = document.getElementById("error-msg");
        error.textContent = "Authenticating...";

        try {
          const res = await fetch(API.login, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          const data = await res.json();
          if (data.success) enterApp();
          else error.textContent = data.message;
        } catch (e) {
          error.textContent = "Connection error";
        }
      });

      function toggleSidebar() {
        const sidebar = document.getElementById("main-sidebar");
        const overlay = document.getElementById("sidebar-overlay");
        sidebar.classList.toggle("active");
        overlay.classList.toggle("active");
      }

      function enterApp() {
        document.getElementById("auth-section").classList.add("hidden");
        document.getElementById("main-app").classList.remove("hidden");
        document.getElementById("mobile-bar").classList.remove("hidden");
        loadAllData();
      }

      async function loadAllData() {
        const btn = document.querySelector(".btn-sync");
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Syncing...";
        console.log("[UI] Fetching all library data...");
        try {
          await Promise.all([loadShelf(), loadLocalLibrary()]);
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }

      let isFetchingShelf = false;
      async function loadShelf() {
        if (isFetchingShelf) {
          console.log("[UI] Already fetching shelf, skipping duplicate call.");
          return;
        }
        isFetchingShelf = true;
        console.log("[UI] Syncing shelf...");

        const grid = document.getElementById("shelf-grid");
        if (!grid.innerHTML.trim()) grid.innerHTML = '<p style="color: var(--subtext0)">Syncing...</p>';

        try {
          const res = await fetch(API.books);
          const data = await res.json();
          if (data.success) {
            shelfState = data.books;
            updateStats();
            renderShelf(data.books);
            return true;
          }
          return false;
        } catch (e) {
          console.error("[UI] Fetch error:", e);
          return false;
        } finally {
          isFetchingShelf = false;
        }
      }

      function renderShelf(books, ignoreComparison = false) {
        const grid = document.getElementById("shelf-grid");

        const bookIds = books
          .map((b) => b.book_id)
          .sort()
          .join(",");
        if (!ignoreComparison && grid.dataset.bookIds === bookIds) {
          console.log("[UI] Shelf list unchanged, updating state only.");
          books.forEach((book) => {
            const card = document.getElementById(`card-${book.book_id}`);
            if (!card) return;
            const isDownloading = activeDownloads.has(book.book_id);
            if (isDownloading) return;

            const actions = card.querySelector(".actions");
            if (book.isLocal) {
              actions.innerHTML = `
                <div class="card-actions-wrapper">
                  <div class="status-badge"><span>‚óè</span> Cloud Synced</div>
                  <div class="actions">
                    <button class="btn btn-primary" onclick="window.open('${API.files}${encodeURIComponent(book.safeName)}/${encodeURIComponent(book.localFilename)}', '_blank')">Open ${sanitizeHTML(book.localFormat)}</button>
                    <button class="btn btn-outline btn-icon" onclick="openFolder('${encodeURIComponent(book.safeName)}')" title="Open Folder" aria-label="Open folder">üìÅ</button>
                    <button class="btn btn-outline btn-icon btn-delete" onclick="removeBook('${encodeURIComponent(book.safeName)}')" title="Delete Local Copy" aria-label="Delete local copy">üóë</button>
                  </div>
                </div>`;
              actions.classList.remove("hidden");
              const prog = document.getElementById(`progress-${book.book_id}`);
              if (prog) prog.style.display = "none";
            } else {
              actions.innerHTML = `<button class="btn btn-primary" onclick="initDownload('${book.book_id}')">Download</button>`;
              actions.classList.remove("hidden");
              const prog = document.getElementById(`progress-${book.book_id}`);
              if (prog) prog.style.display = "none";
            }
          });
          return;
        }

        grid.dataset.bookIds = bookIds;
        grid.innerHTML = books
          .map((book) => {
            const isDownloading = activeDownloads.has(book.book_id);
            const state = isDownloading ? activeDownloads.get(book.book_id) : { percentage: 0, status: "Pending" };
            return `
          <div class="card" id="card-${book.book_id}" role="listitem">
            <div class="book-meta">
              <h3>${sanitizeHTML(book.book_title)}</h3>
              <p>${sanitizeHTML(book.book_author)}</p>
            </div>

            <div class="progress-box" id="progress-${book.book_id}" style="${isDownloading ? "display: block" : ""}">
              <div class="progress-bar"><div class="progress-inner" id="fill-${book.book_id}" style="width: ${
              state.percentage
            }%"></div></div>
              <div class="progress-text">
                <span id="status-${book.book_id}">${sanitizeHTML(state.status)}</span>
                <span id="percent-${book.book_id}">${state.percentage}%</span>
              </div>
            </div>

            <div class="actions ${isDownloading ? "hidden" : ""}" id="actions-${book.book_id}">
              ${
                book.isLocal
                  ? `
                <div class="card-actions-wrapper">
                  <div class="status-badge"><span>‚óè</span> Cloud Synced</div>
                  <div class="actions">
                    <button class="btn btn-primary" onclick="window.open('${API.files}${encodeURIComponent(book.safeName)}/${encodeURIComponent(book.localFilename)}', '_blank')">Open ${sanitizeHTML(book.localFormat)}</button>
                    <button class="btn btn-outline btn-icon" onclick="openFolder('${encodeURIComponent(book.safeName)}')" title="Open Folder" aria-label="Open folder">üìÅ</button>
                    <button class="btn btn-outline btn-icon btn-delete" onclick="removeBook('${encodeURIComponent(book.safeName)}')" title="Delete Local Copy" aria-label="Delete local copy">üóë</button>
                  </div>
                </div>
              `
                  : `
                <button class="btn btn-primary" onclick="initDownload('${book.book_id}')" aria-label="Download ${sanitizeHTML(book.book_title)}">Download</button>
              `
              }
            </div>
          </div>
        `;
          })
          .join("");
      }

      let isFetchingLibrary = false;
      async function loadLocalLibrary() {
        if (isFetchingLibrary) return;
        isFetchingLibrary = true;
        const grid = document.getElementById("local-grid");
        if (!grid.innerHTML.trim()) grid.innerHTML = '<p style="color: var(--subtext0)">Loading...</p>';

        try {
          const res = await fetch(API.library);
          const data = await res.json();
          if (data.success) {
            localState = data.books;
            updateStats();
            renderLocalLibrary(data.books);
          }
        } finally {
          isFetchingLibrary = false;
        }
      }

      function renderLocalLibrary(books) {
        const grid = document.getElementById("local-grid");
        if (books.length === 0) {
          grid.innerHTML = '<p class="empty-state">Empty Library</p>';
          return;
        }
        grid.innerHTML = books
          .map(
            (book) => `
          <div class="card" role="listitem">
            <div class="book-meta">
              <h3>${sanitizeHTML(book.title)}</h3>
              <p>Format: ${sanitizeHTML(book.format)}</p>
            </div>
            <div class="actions">
              <button class="btn btn-primary" onclick="window.open('${API.files}${encodeURIComponent(book.id)}/${encodeURIComponent(book.filename)}', '_blank')" aria-label="View ${sanitizeHTML(book.title)}">View</button>
              <button class="btn btn-outline btn-icon" onclick="openFolder('${encodeURIComponent(book.id)}')" title="Open Folder" aria-label="Open folder">üìÅ</button>
              <button class="btn btn-outline btn-icon btn-delete" onclick="removeBook('${encodeURIComponent(book.id)}')" title="Delete Local Copy" aria-label="Delete local copy">üóë</button>
            </div>
          </div>
        `
          )
          .join("");
      }

      function initDownload(bookId) {
        if (activeDownloads.has(bookId)) return;
        activeDownloads.set(bookId, { percentage: 0, status: "Starting..." });

        const actions = document.getElementById(`actions-${bookId}`);
        const progress = document.getElementById(`progress-${bookId}`);
        if (actions) actions.classList.add("hidden");
        if (progress) progress.style.display = "block";

        fetch(API.download + bookId, { method: "POST" }).then((response) => {
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          function read() {
            reader.read().then(({ done, value }) => {
              if (done) {
                activeDownloads.delete(bookId);
                return;
              }
              const chunk = decoder.decode(value);
              chunk.split("\n").forEach((line) => {
                if (line.startsWith("data: ")) {
                  const data = JSON.parse(line.substring(6));
                  const fill = document.getElementById(`fill-${bookId}`);
                  const status = document.getElementById(`status-${bookId}`);
                  const percent = document.getElementById(`percent-${bookId}`);
                  const pBox = document.getElementById(`progress-${bookId}`);
                  const aBox = document.getElementById(`actions-${bookId}`);

                  if (pBox) pBox.style.display = "block";
                  if (aBox) aBox.classList.add("hidden");

                  if (data.type === "progress") {
                    activeDownloads.set(bookId, { percentage: data.percentage, status: data.status });
                    if (fill) fill.style.width = data.percentage + "%";
                    if (status) status.textContent = data.status;
                    if (percent) percent.textContent = data.percentage + "%";
                  } else if (data.type === "complete") {
                    activeDownloads.delete(bookId);
                    if (status) status.textContent = "Synced!";
                    if (fill) fill.style.background = "var(--green)";
                    setTimeout(() => {
                      loadShelf();
                      loadLocalLibrary();
                    }, 1500);
                  }
                }
              });
              read();
            });
          }
          read();
        });
      }

      async function openFolder(safeName) {
        await fetch(API.openFolder + safeName, { method: "POST" });
      }

      async function removeBook(safeName) {
        if (!confirm("Remove this book from your local offline library?")) return;
        try {
          const res = await fetch(API.delete + safeName, { method: "POST" });
          const data = await res.json();
          if (data.success) {
            loadAllData();
          } else {
            alert(data.message || "Failed to delete.");
          }
        } catch (e) {
          alert("Error connecting to server.");
        }
      }

      async function logout() {
        if (!confirm("Are you sure you want to end this session?")) return;
        await fetch(API.logout, { method: "POST" });
        window.location.reload();
      }

      function updateStats() {
        document.getElementById("stat-shelf").textContent = shelfState.length;
        document.getElementById("stat-local").textContent = localState.length;
      }

      window.onload = async () => {
        console.log("[UI] App initializing...");
        const isLoggedIn = await loadShelf();
        if (isLoggedIn) {
          document.getElementById("auth-section").classList.add("hidden");
          document.getElementById("main-app").classList.remove("hidden");
          document.getElementById("mobile-bar").classList.remove("hidden");
          loadAllData();
        }
      };
    </script>
  </body>
</html>
